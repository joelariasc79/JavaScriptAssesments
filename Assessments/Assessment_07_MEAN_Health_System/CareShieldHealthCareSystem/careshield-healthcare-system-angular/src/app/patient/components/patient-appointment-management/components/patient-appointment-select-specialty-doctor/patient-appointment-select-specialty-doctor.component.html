<script src="https://cdn.tailwindcss.com"></script>

<style>
  .step-card {
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
  }
</style>

<div class="min-h-screen bg-gray-50 flex items-start justify-center p-4 sm:p-6 lg:p-8">
  <div class="w-full max-w-4xl mt-10 space-y-8">

    <!-- Header -->
    <header class="text-center">
      <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Book an Appointment</h1>
      <p class="mt-2 text-lg text-gray-500">Step 1: Link Screening and Select a Doctor</p>
    </header>

    <!-- Main Content Card -->
    <div class="step-card bg-white p-6 sm:p-10 rounded-xl border border-gray-100">

      <!-- Error/Message Alert -->
      @if (message()) {
        <div class="p-3 mb-6 rounded-lg text-sm transition-all duration-300"
             [ngClass]="{'bg-red-100 text-red-700 border border-red-200': error(), 'bg-blue-100 text-blue-700 border border-blue-200': !error() && message()}">
          {{ message() }}
        </div>
      }

      <div class="space-y-8">

        <!-- 1. Screening Selection -->
        <div>
          <label for="screening" class="block text-base font-semibold text-gray-700 mb-2">
            1. Select Existing Screening Record
          </label>
          @if (loadingScreenings()) {
            <div class="text-blue-500 text-sm">Loading your recent screenings...</div>
          } @else if (patientScreenings().length === 0) {
            <div class="p-4 bg-yellow-50 text-yellow-700 rounded-lg text-sm">
              No open screenings found. You must submit a screening first.
            </div>
          } @else {
            <select id="screening" name="screening" [ngModel]="selectedScreeningId()" (change)="onScreeningChange($event)"
                    class="mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg border-2 shadow-sm
                           hover:border-indigo-400 transition-colors duration-150"
                    [class.border-red-500]="formSubmitted() && !selectedScreeningId()">
              <option [ngValue]="undefined" disabled>-- Choose a Screening --</option>
              @for (screening of patientScreenings(); track screening._id) {
                <option [ngValue]="screening._id">
                  {{ screening.chiefComplaint | slice:0:50 }}... ({{ screening.createdAt | date: 'mediumDate' }})
                </option>
              }
            </select>
            <p class="mt-2 text-xs text-gray-500">
              Select the record that best describes the reason for this appointment.
            </p>
          }
        </div>

        <!-- 2. Specialty Selection -->
            <div class="mb-6">
              <label for="specialty-select" class="text-sm font-medium text-gray-700 mb-2 block">
                Select Specialty: <span class="text-red-500">*</span>
              </label>
              <select
                id="specialty-select"
                class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"
                [ngModel]="selectedSpecialty()"
                (change)="onSpecialtyChange($event)"
              >
                <option value="">-- Choose a Specialty --</option>
                <option *ngFor="let specialtyKey of specialtyKeys" [value]="specialtyKey">
                  {{ specialtyKey }}
                </option>
              </select>
            </div>

        <!-- 3. Doctor Selection (Filtered List) -->
        <div>
          <label class="block text-base font-semibold text-gray-700 mb-2">
            3. Select an Available Doctor
          </label>
          @if (loading()) {
            <div class="p-4 flex items-center justify-center bg-indigo-50 text-indigo-700 rounded-lg">
              <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Fetching doctors for {{ selectedSpecialty() }}...
            </div>
          } @else if (filteredDoctors().length > 0) {
            <div class="space-y-3">
              @for (doctor of filteredDoctors(); track doctor._id) {
                <label [for]="'doctor-' + doctor._id"
                       class="flex items-center p-4 border rounded-lg cursor-pointer transition-shadow duration-150"
                       [ngClass]="{
                           'bg-indigo-50 border-indigo-500 ring-2 ring-indigo-500': selectedDoctorId() === doctor._id,
                           'bg-white border-gray-200 hover:shadow-md': selectedDoctorId() !== doctor._id
                       }">
                  <input type="radio" [id]="'doctor-' + doctor._id" [name]="'selectedDoctor'" [value]="doctor._id"
                         (change)="selectedDoctorId.set(doctor._id)" class="hidden">

                  <div class="flex-shrink-0 w-10 h-10 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold text-lg mr-4">
                    {{ doctor.name.charAt(0) }}
                  </div>
                  <div class="flex-1">
                    <p class="text-sm font-medium text-gray-900">{{ doctor.name }}</p>
                    <p class="text-xs text-gray-500">{{ doctor.experience }} Yrs Exp. | ${{ doctor.fees }} Fee</p>
                  </div>
                  @if (selectedDoctorId() === doctor._id) {
                    <svg class="w-5 h-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 13.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                  }
                </label>
              }
            </div>
          } @else if (selectedSpecialty()) {
            <div class="p-4 bg-gray-50 text-gray-700 rounded-lg text-sm border-2 border-dashed border-gray-200">
              Please select a specialty above to see available doctors.
            </div>
          }
        </div>

      </div>

      <!-- Action Buttons -->
      <div class="mt-10 flex justify-between space-x-4">
        <button (click)="onCancel()" type="button"
                class="px-6 py-3 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors duration-150">
          Cancel
        </button>
        <button (click)="onNext()" type="submit"
                [disabled]="!isSelectionValid()"
                class="px-6 py-3 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
          Proceed to Availability ({{ isSelectionValid() ? 'Next' : '...' }})
        </button>
      </div>
    </div>
  </div>
</div>
