<div class="step-card bg-white p-6 sm:p-10 rounded-xl border border-gray-100">
  <h3 class="text-2xl font-bold text-gray-800 mb-4">
    {{ isUpdateMode ? 'Update' : 'Leave' }} Feedback
  </h3>

  <!-- Loading/Error/Success Messages -->
  <div *ngIf="isLoading" class="p-4 mb-4 text-sm text-blue-700 bg-blue-100 rounded-lg">
    Loading clinical encounters and feedback data...
  </div>

  <div *ngIf="errorMessage" class="p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
    <strong>Error:</strong> {{ errorMessage }}
  </div>

  <div *ngIf="successMessage" class="p-4 mb-4 text-sm text-green-700 bg-green-100 rounded-lg" role="alert">
    <strong>Success:</strong> {{ successMessage }}
  </div>

  <form (ngSubmit)="onSubmit()" class="space-y-6" *ngIf="!isLoading">

    <!-- Encounter Select Box -->
    <div>
      <label for="encounter-select" class="text-sm font-medium text-gray-700 mb-1 block">
        Select Clinical Encounter:
      </label>
      <select id="encounter-select" name="selectedEncounterId" [(ngModel)]="selectedEncounterId" (change)="onEncounterChange()"
              [disabled]="isUpdateMode"
              class="mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg border-2 shadow-sm
                     hover:border-indigo-400 transition-colors duration-150 disabled:bg-gray-50 disabled:cursor-not-allowed">
        <option [ngValue]="null" disabled>-- Select an Encounter --</option>
        <option *ngFor="let encounter of encounters" [ngValue]="encounter._id">
          {{ encounter.startTime | date:'mediumDate' }} - Dr. {{ encounter.doctorId.name }} ({{ encounter.reasonForVisit | slice:0:30 }}...)
        </option>
      </select>
      <p *ngIf="!selectedEncounterId" class="text-xs text-red-500 mt-1">
        Please select an encounter to proceed.
      </p>
    </div>

    <!-- Doctor Name Display -->
    <div *ngIf="selectedEncounter" class="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
      <p class="text-base text-gray-800">Doctor to Review:
        <span class="font-semibold text-indigo-700">
          Dr. {{ selectedEncounter.doctorId.name }}
        </span>
      </p>
    </div>

    <!-- Rating Input -->
    <div class="flex flex-col">
      <label for="rating-group" class="text-sm font-medium text-gray-700 mb-1">
        Rating (1 to 5):
      </label>
      <div id="rating-group" role="radiogroup" aria-label="Rating from 1 to 5 stars" class="flex items-center space-x-1">
        <ng-container *ngFor="let star of [1, 2, 3, 4, 5]">
          <button type="button" (click)="setRating(star)"
                  [attr.aria-label]="star + ' out of 5 stars'"
                  [attr.aria-checked]="formRating === star ? 'true' : 'false'"
                  role="radio"
                  [class]="star <= (formRating ?? 0) ? 'text-yellow-400' : 'text-gray-300'"
                  class="h-8 w-8 transition duration-150 hover:text-yellow-500 focus:outline-none">
            <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
              <path d="M9.049 2.927c.3-.921 1.631-.921 1.932 0l1.961 6.046h6.353c.969 0 1.371 1.24.588 1.81l-5.14 3.737 1.961 6.046c.3.921-.755 1.688-1.538 1.11L10 16.141l-5.14 3.737c-.783.578-1.838-.189-1.538-1.11l1.961-6.046-5.14-3.737c-.783-.57-.381-1.81.588-1.81h6.353l1.961-6.046z"/>
            </svg>
          </button>
        </ng-container>
      </div>
      <p *ngIf="ratingError" class="text-xs text-red-500 mt-1">{{ ratingError }}</p>
    </div>

    <!-- Comment Input -->
    <div>
      <label for="comment" class="text-sm font-medium text-gray-700 mb-1 block">
        Comment (Optional):
      </label>
      <textarea id="comment" name="comment" [(ngModel)]="formComment" rows="4"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                placeholder="Write your experience with the doctor here..."></textarea>
    </div>

    <!-- Action Buttons -->
    <div class="pt-4 flex justify-end space-x-3">
      <button type="button" (click)="onCancel()"
              class="px-6 py-3 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors duration-150">
        Cancel
      </button>
      <button type="submit" [disabled]="isSubmitting || !formRating || !selectedEncounterId || ratingError"
              class="flex justify-center py-3 px-6 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed transition duration-150">
        <svg *ngIf="isSubmitting" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>{{ isUpdateMode ? 'Update Feedback' : 'Submit Feedback' }}</span>
      </button>
    </div>
  </form>

  <!-- No Encounters Found Message -->
  <div *ngIf="!isLoading && encounters.length === 0" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mt-6" role="alert">
    <p class="font-bold">No Encounters Available</p>
    <p>You can only leave feedback on clinical encounters with a status of 'Final'.</p>
  </div>
</div>
