<script src="https://cdn.tailwindcss.com"></script>
<div class="p-4 sm:p-6 lg:p-8 bg-gray-50 min-h-screen font-sans">

  <!-- Header -->
  <div class="flex justify-between items-center mb-6 border-b pb-3">
    <h1 class="text-3xl font-extrabold text-indigo-800">
      <span class="text-indigo-400">#{{ encounterId() }}</span> Clinical Encounter Record
    </h1>
    @if (encounterStatus() === 'Final') {
      <span class="px-4 py-2 text-sm font-semibold text-white bg-green-500 rounded-full shadow-md">
            FINALIZED
          </span>
    } @else if (encounterStatus() === 'Amended') {
      <span class="px-4 py-2 text-sm font-semibold text-white bg-yellow-600 rounded-full shadow-md">
            AMENDED
          </span>
    } @else {
      <span class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-full shadow-md">
            DRAFT
          </span>
    }
  </div>

  @if (isLoading()) {
    <div class="flex items-center justify-center h-64 text-gray-500">
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Loading clinical encounter...
    </div>
  } @else if (errorMessage()) {
    <div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg shadow-md">
      <p class="font-bold">Error/Warning:</p>
      <p>{{ errorMessage() }}</p>
    </div>
  } @else {
    <form (ngSubmit)="saveEncounter()" class="space-y-8">

      <!-- Section 1: Read-Only Context (Appointment & Patient Info) -->
      <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Context Information (Read-Only)</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

          <!-- Patient Info -->
          <div class="col-span-1 md:col-span-2 space-y-3">
            <p class="text-sm font-medium text-gray-500">Patient:</p>
            <p class="text-lg font-semibold text-indigo-800">{{ encounter()?.patientId?.name }}</p>
            <p class="text-xs text-gray-400">ID: {{ encounter()?.patientId?._id }} | Contact: {{ encounter()?.patientId?.contact_number }}</p>
          </div>

          <!-- Doctor & Hospital Info -->
          <div class="col-span-1 space-y-3 border-l pl-4">
            <p class="text-sm font-medium text-gray-500">Assigned Doctor:</p>
            <p class="text-md font-semibold text-gray-800">{{ encounter()?.doctorId?.name }} ({{ encounter()?.doctorId?.specialty }})</p>
            <p class="text-sm text-gray-400">Hospital: {{ encounter()?.hospitalId?.name }}</p>
          </div>

          <!-- Appointment Time/Reason -->
          <div class="md:col-span-3 grid grid-cols-1 sm:grid-cols-4 gap-4 pt-4 border-t mt-4">
            <div class="sm:col-span-2">
              <label class="block text-sm font-medium text-gray-500">Reason for Visit</label>
              <p class="mt-1 text-gray-800 font-medium">{{ encounter()?.reasonForVisit }}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-500">Start</label>
              <p class="mt-1 text-gray-800">{{ encounter()?.startTime | date:'shortTime' }}</p>
              <p class="text-xs text-gray-400">{{ encounter()?.startTime | date:'mediumDate' }}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-500">Duration</label>
              <p class="mt-1 text-gray-800">{{ encounter()?.durationMinutes }} min</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Section 2: Patient Screening Data (Read-Only) -->
      @if (isScreeningLoading()) {
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
          <div class="flex items-center justify-center text-gray-500 h-16">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading pre-assessment data...
          </div>
        </div>
      } @else if (screening()) {
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-400 shadow-md">
          <h2 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2 flex items-center">
            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-9 0V3h4m-4 2a2 2 0 00-2 2h-2m0 0a2 2 0 002 2h-2m0 0a2 2 0 002 2h-2m0 0a2 2 0 002 2h-2m0 0a2 2 0 002 2h-2m0 0a2 2 0 002 2h-2"></path></svg>
            Pre-Assessment Data (Screening)
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <div class="space-y-4">
              <!-- Chief Complaint -->
              <div>
                <label class="block text-sm font-medium text-gray-500">Chief Complaint</label>
                <p class="mt-1 text-gray-800 font-semibold">{{ screening()!.chiefComplaint }}</p>
              </div>

              <!-- Symptom Description -->
              <div>
                <label class="block text-sm font-medium text-gray-500">Symptom Description</label>
                <p class="mt-1 text-gray-800">{{ screening()!.symptomDescription }}</p>
              </div>
            </div>

            <div class="space-y-4 border-l pl-4">
              <!-- Pain Level -->
              <div>
                <label class="block text-sm font-medium text-gray-500">Pain Level (1-10)</label>
                <p class="mt-1 text-lg font-bold" [ngClass]="{'text-red-600': screening()!.painLevel > 7, 'text-yellow-600': screening()!.painLevel > 4 && screening()!.painLevel <= 7, 'text-green-600': screening()!.painLevel <= 4}">
                  {{ screening()!.painLevel }} / 10
                </p>
              </div>

              <!-- Duration -->
              <div>
                <label class="block text-sm font-medium text-gray-500">Symptom Duration</label>
                <p class="mt-1 text-gray-800">{{ screening()!.duration }}</p>
              </div>

              <!-- Current Medications (Assumes simple string or string array in model) -->
              <div>
                <label class="block text-sm font-medium text-gray-500">Current Medications</label>
                <p class="mt-1 text-gray-800 italic">{{ screening()!.currentMedications }}</p>
              </div>
            </div>
          </div>
        </div>
      } @else if (!screening() && !isScreeningLoading() && screeningIdFromEncounter()) {
        <!-- FIX: Using the computed signal for the ID existence check -->
          <!-- Shows a message if the screeningId exists but failed to load -->
        <div class="p-4 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded-lg shadow-md">
          <p>Could not load the pre-assessment (ID: {{ screeningIdFromEncounter() }}). The encounter record remains editable.</p>
        </div>
      }

      <!-- Section 3: Clinical Data (Editable) -->
      <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 space-y-6">
        <h2 class="text-xl font-bold text-gray-700 border-b pb-2">Clinical Data and Medical Notes</h2>

        <!-- Diagnosis -->
        <div>
          <label for="diagnosis" class="block text-sm font-medium text-gray-700 mb-1">Primary Diagnosis</label>
          <input
            id="diagnosis"
            type="text"
            [(ngModel)]="diagnosis"
            name="diagnosis"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150 ease-in-out"
            placeholder="E.g.: Pneumonia, Type II Diabetes..."
          />
        </div>

        <!-- Physician Notes -->
        <div>
          <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Physician Notes</label>
          <textarea
            id="notes"
            [(ngModel)]="physicianNotes"
            name="physicianNotes"
            required
            rows="4"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150 ease-in-out"
            placeholder="Exam details, procedures performed, findings..."
          ></textarea>
        </div>

        <!-- Recommendations -->
        <div>
          <label for="recommendations" class="block text-sm font-medium text-gray-700 mb-1">Recommendations and Instructions (Optional)</label>
          <textarea
            id="recommendations"
            [(ngModel)]="recommendations"
            name="recommendations"
            rows="2"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150 ease-in-out"
            placeholder="Follow-up instructions, lifestyle changes, etc."
          ></textarea>
        </div>
      </div>

      <!-- Section 4: Prescriptions (Dynamic) -->
      <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Prescriptions</h2>

        @for (prescription of prescriptions(); track $index) {
          <div class="grid grid-cols-12 gap-4 border-b border-gray-100 py-3 mb-3">
            <!-- Medication Name -->
            <div class="col-span-12 sm:col-span-4">
              <label class="block text-xs font-medium text-gray-500">Medication</label>
              <input
                type="text"
                [(ngModel)]="prescription.medicationName"
                name="medName-{{$index}}"
                placeholder="Name"
                class="w-full text-sm px-3 py-1 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
              />
            </div>

            <!-- Dosage -->
            <div class="col-span-6 sm:col-span-2">
              <label class="block text-xs font-medium text-gray-500">Dosage</label>
              <input
                type="text"
                [(ngModel)]="prescription.dosage"
                name="dosage-{{$index}}"
                placeholder="Dosage"
                class="w-full text-sm px-3 py-1 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
              />
            </div>

            <!-- Frequency -->
            <div class="col-span-6 sm:col-span-3">
              <label class="block text-xs font-medium text-gray-500">Frequency</label>
              <input
                type="text"
                [(ngModel)]="prescription.frequency"
                name="freq-{{$index}}"
                placeholder="Frequency"
                class="w-full text-sm px-3 py-1 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
              />
            </div>

            <!-- Remove Button -->
            <div class="col-span-12 sm:col-span-3 flex items-end justify-end">
              <button
                type="button"
                (click)="removePrescription($index)"
                class="w-full sm:w-auto px-3 py-1 text-sm text-white bg-red-500 rounded-lg hover:bg-red-600 transition duration-150 shadow-md">
                Remove
              </button>
            </div>
          </div>
        }

        <div class="flex justify-end pt-2">
          <button
            type="button"
            (click)="addPrescription()"
            class="px-4 py-2 text-sm font-semibold text-indigo-600 border border-indigo-600 rounded-lg hover:bg-indigo-50 transition duration-150 shadow-sm">
            + Add Medication
          </button>
        </div>
      </div>

      <!-- Section 5: Status and Action -->
      <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Status Update -->
          <div>
            <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Record Status</label>
            <select
              id="status"
              [(ngModel)]="status"
              name="status"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150 ease-in-out"
            >
              @for (statusOption of statusOptions; track statusOption) {
                <option [value]="statusOption">{{ statusOption }}</option>
              }
            </select>
            <p class="mt-2 text-xs text-gray-500">Changing to 'Final' will sign the document. Changing to 'Amended' allows revisions to a finalized record.</p>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-col sm:flex-row justify-end items-end gap-3 mt-4">
            <button
              type="button"
              (click)="cancel()"
              class="w-full sm:w-auto px-6 py-3 text-sm font-bold text-gray-600 bg-gray-200 rounded-xl hover:bg-gray-300 transition duration-150 shadow-md">
              Cancel
            </button>
            <button
              type="submit"
              [disabled]="isSaving()"
              class="w-full sm:w-auto px-6 py-3 text-sm font-bold text-white bg-indigo-600 rounded-xl hover:bg-indigo-700 transition duration-150 shadow-xl disabled:opacity-50 disabled:cursor-not-allowed">
              @if (isSaving()) {
                <div class="flex items-center">
                  <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  Saving...
                </div>
              } @else {
                Save Changes
              }
            </button>
          </div>
        </div>
      </div>
    </form>
  }
</div>
